<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chat Online • Usuário / ADM</title>
  <style>
    :root{
      --bg:#101418; --panel:#151a20; --card:#1b2129; --bubble-user:#2a2f36;
      --bubble-adm:#0e5f3b; --text:#e6eef7; --muted:#a7b0bb; --line:#242a32; --accent:#00e29f;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0; background:var(--bg); color:var(--text); font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial}
    a.link{color:var(--muted); text-decoration:none} a.link:hover{text-decoration:underline}
    .login-card{max-width:420px; margin:10vh auto; padding:24px; background:var(--card); border:1px solid var(--line); border-radius:12px}
    .login-card h1{margin:0 0 12px} .login-card label{display:block; margin:12px 0 6px; color:var(--muted)}
    .login-card input{width:100%; padding:12px; border-radius:8px; border:1px solid var(--line); background:#0c1014; color:var(--text)}
    .login-card button{margin-top:16px; width:100%; padding:12px; border:0; border-radius:8px; background:var(--accent); color:#002417; font-weight:700; cursor:pointer}
    .hint{color:var(--muted); font-size:14px}
    .hidden{display:none!important}
    .chat-wrap{display:flex; flex-direction:column; height:100vh; max-width:920px; margin:0 auto}
    .chat-header{display:flex; align-items:center; justify-content:space-between; padding:12px 16px; border-bottom:1px solid var(--line); background:var(--panel); position:sticky; top:0; z-index:10}
    .chat-title{font-weight:700} .chat-subtitle{color:var(--muted); font-size:13px}
    .btn-link,.link{background:none; border:0; color:var(--muted); cursor:pointer}
    .messages{flex:1; overflow-y:auto; padding:16px; background:linear-gradient(#0c1116,#0b0e12)}
    .msg{max-width:70%; padding:10px 12px; margin:6px 0; border-radius:14px; position:relative; word-wrap:break-word; white-space:pre-wrap}
    .msg .time{display:block; margin-top:6px; font-size:11px; color:var(--muted); text-align:right; opacity:.8}
    .me{background:var(--bubble-user); border-top-left-radius:4px}
    .adm{background:var(--bubble-adm); border-top-right-radius:4px}
    .center{margin:10px auto; text-align:center; color:var(--muted); font-size:12px}
    .composer{border-top:1px solid var(--line); background:var(--panel); padding:10px}
    .composer form{display:flex; gap:10px}
    .composer input{flex:1; padding:12px; border-radius:999px; border:1px solid var(--line); background:#0c1014; color:var(--text)}
    .composer button{padding:0 18px; border-radius:999px; border:0; background:var(--accent); color:#002417; font-weight:800; cursor:pointer}
    .admin-layout{display:grid; grid-template-columns:320px 1fr; height:100vh}
    .sidebar{border-right:1px solid var(--line); background:var(--panel); display:flex; flex-direction:column}
    .brand{padding:14px 16px; font-weight:800; border-bottom:1px solid var(--line)}
    .search{padding:8px 10px; border-bottom:1px solid var(--line)}
    .search input{width:100%; padding:10px; border-radius:8px; border:1px solid var(--line); background:#0c1014; color:var(--text)}
    .rooms{list-style:none; margin:0; padding:0; overflow-y:auto}
    .room{padding:12px 14px; border-bottom:1px solid var(--line); cursor:pointer; display:flex; gap:10px; align-items:center}
    .room:hover{background:#10161d}
    .room .title{font-weight:700} .room .sub{color:var(--muted); font-size:12px}
    .badge{background:var(--accent); color:#002417; font-weight:800; padding:0 8px; border-radius:999px; font-size:12px; margin-left:auto}
    .dot{display:inline-block; width:8px; height:8px; border-radius:50%; background:#666; margin-right:6px; vertical-align:middle}
    .dot.online{background:#1bd760}
    #view-user{display:block} #view-admin{display:none}
  </style>
</head>
<body>

  <!-- ============ VIEW: USUÁRIO ============ -->
  <div id="view-user">
    <div id="app">
      <section class="login-card" id="loginCard">
        <h1>Entrar no Chat</h1>
        <form id="loginForm">
          <label>Nome</label>
          <input id="nomeInput" required placeholder="Ex.: Ana" />
          <label>Setor</label>
          <input id="setorInput" required placeholder="Ex.: Financeiro" />
          <button type="submit">Entrar</button>
        </form>
        <p class="hint">
          Seu chat abrirá em tempo real com o administrador.<br />
          <a class="link" href="#/admin">Painel do ADM</a>
        </p>
      </section>

      <section class="chat-wrap hidden" id="chatWrap">
        <header class="chat-header">
          <div>
            <div class="chat-title" id="chatTitle">—</div>
            <div class="chat-subtitle"><span id="statusDot" class="dot"></span><span id="statusText">Conectando…</span></div>
          </div>
          <button id="sairBtn" class="btn-link">sair</button>
        </header>

        <main id="messages" class="messages"></main>

        <footer class="composer">
          <form id="msgForm">
            <input id="msgInput" placeholder="Digite sua mensagem" autocomplete="off" />
            <button type="submit" title="Enviar">➤</button>
          </form>
        </footer>
      </section>
    </div>
  </div>

  <!-- ============ VIEW: ADM ============ -->
  <div id="view-admin">
    <div class="admin-layout">
      <aside class="sidebar">
        <div class="brand">Painel do ADM</div>
        <div class="search"><input id="filterInput" placeholder="Filtrar por nome/setor" /></div>
        <ul id="roomsList" class="rooms"></ul>
      </aside>

      <section class="chat-area">
        <header class="chat-header">
          <div>
            <div class="chat-title" id="roomTitle">Selecione uma conversa</div>
            <div class="chat-subtitle"><span id="roomStatusDot" class="dot"></span><span id="roomStatusText"></span></div>
          </div>
          <a class="link" href="#/user">← Voltar ao usuário</a>
        </header>

        <main id="adminMessages" class="messages"></main>

        <footer class="composer">
          <form id="adminMsgForm">
            <input id="adminMsgInput" placeholder="Escreva uma resposta…" autocomplete="off" disabled />
            <button type="submit" title="Enviar" disabled>➤</button>
          </form>
        </footer>
      </section>
    </div>

    <audio id="ding" preload="auto">
      <source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" type="audio/ogg">
    </audio>
  </div>

  <!-- ====================== SCRIPTS ====================== -->
<script type="module">
  // ---------- IMPORTS FIREBASE ----------
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import {
    getDatabase, ref, onChildAdded, push, set, serverTimestamp,
    onDisconnect, onValue, update, get, child
  } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

  // ---------- IMPORTA SUA CONFIG ----------
  import { firebaseConfig } from "./firebase-config.js";

  // ---------- INICIALIZA FIREBASE ----------
  const app = initializeApp(firebaseConfig);
  const db  = getDatabase(app);
  const auth = getAuth(app);

  // Helpers gerais
  const $ = sel => document.querySelector(sel);
  const fmtTime = ts => new Date(Number(ts||Date.now())).toLocaleString();
  const escapeHtml = s => String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

  // ======= ELEMENTOS (USUÁRIO) =======
  const loginCard = $('#loginCard');
  const chatWrap  = $('#chatWrap');
  const loginForm = $('#loginForm');
  const nomeInput = $('#nomeInput');
  const setorInput= $('#setorInput');
  const chatTitle = $('#chatTitle');
  const messagesEl= $('#messages');
  const msgForm   = $('#msgForm');
  const msgInput  = $('#msgInput');
  const statusDot = $('#statusDot');
  const statusText= $('#statusText');
  const sairBtn   = $('#sairBtn');

  // ======= ELEMENTOS (ADM) =======
  const roomsList  = $('#roomsList');
  const filterInput= $('#filterInput');
  const adminMessages = $('#adminMessages');
  const roomTitle  = $('#roomTitle');
  const roomStatusDot = $('#roomStatusDot');
  const roomStatusText= $('#roomStatusText');
  const adminMsgForm  = $('#adminMsgForm');
  const adminMsgInput = $('#adminMsgInput');
  const ding = $('#ding');

  // ======= ROTEADOR =======
  const views = { user: $('#view-user'), admin: $('#view-admin') };
  function show(route){
    Object.values(views).forEach(v => v && (v.style.display='none'));
    if(route === 'admin'){ views.admin && (views.admin.style.display='block'); }
    else { views.user && (views.user.style.display='block'); }
  }
  function resolve(){ const route=(location.hash.replace('#/','')||'user').split('/')[0]; show(route); }
  window.addEventListener('hashchange', resolve); resolve();

  // ========= ESTADO =========
  let roomId = null;
  let userLabel = null;
  let roomRef = null;
  let msgsRef = null;

  let currentRoomId = null;
  let currentMsgsRef = null;

  // ========= UTILS =========
  function slugify(s){
    return s.normalize("NFD").replace(/[\u0300-\u036f]/g,"")
      .toLowerCase().trim().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');
  }
  function scrollBottom(el){ el.scrollTop = el.scrollHeight; }
  function isFromOther(msg){ return msg.destinatario === "Usuário"; }

  function openChatUI(nome, setor){
    loginCard.classList.add('hidden');
    chatWrap.classList.remove('hidden');
    chatTitle.textContent = `${nome} • ${setor}`;
  }
  function resetUserView(){
    loginCard.classList.remove('hidden');
    chatWrap.classList.add('hidden');
  }

  // ========= LÓGICA DO USUÁRIO =========
  function attachRoom(nome, setor){
    roomRef = ref(db, `chats/${roomId}`);
    msgsRef = ref(db, `chats/${roomId}/messages`);

    update(roomRef, {
      userLabel,
      createdAt: serverTimestamp(),
      lastSeenUser: serverTimestamp(),
      status: { userOnline: true, adminOnline: false }
    });

    const presenceRef = ref(db, `chats/${roomId}/status/userOnline`);
    const lastSeenRef = ref(db, `chats/${roomId}/status/userLastSeen`);
    set(presenceRef, true);
    onDisconnect(presenceRef).set(false);
    onDisconnect(lastSeenRef).set(serverTimestamp());

    onValue(ref(db, `chats/${roomId}/status/adminOnline`), snap=>{
      const online = !!snap.val();
      statusDot.classList.toggle('online', online);
      statusText.textContent = online ? 'ADM online' : 'ADM offline';
    });

    messagesEl.innerHTML = `<div class="center">Chat aberto. Fale com o ADM.</div>`;
    onChildAdded(msgsRef, snapshot=>{
      const { texto, timestamp, destinatario } = snapshot.val();
      const isAdm = destinatario === "Usuário";
      const bubble = document.createElement('div');
      bubble.className = `msg ${isAdm ? 'adm' : 'me'}`;
      bubble.innerHTML = `${escapeHtml(texto)}<span class="time">${fmtTime(timestamp)}</span>`;
      messagesEl.appendChild(bubble);
      if(isFromOther({destinatario})) scrollBottom(messagesEl);
    });
  }

  function loadFromLocal(){
    try{
      const saved = JSON.parse(localStorage.getItem('chatUser') || 'null');
      if(saved && saved.roomId && saved.userLabel && saved.nome && saved.setor){
        ({ roomId, userLabel } = saved);
        openChatUI(saved.nome, saved.setor);
        attachRoom(saved.nome, saved.setor);
      } else {
        resetUserView();
      }
    }catch{ resetUserView(); }
  }

  // ========= LÓGICA DO ADMIN =========
  function renderRoomLi(id, data){
    const li = document.createElement('li'); li.className='room'; li.dataset.id=id;
    const title = document.createElement('div'); title.className='title'; title.textContent=data.userLabel||id;
    const sub = document.createElement('div'); sub.className='sub';
    sub.textContent = data.lastMessage ? `${data.lastMessage} • ${new Date(data.lastMessageAt||Date.now()).toLocaleTimeString()}` : 'Sem mensagens';
    const badge = document.createElement('span'); badge.className='badge'; badge.textContent='0'; badge.style.display='none';
    li.append(title, sub, badge); li.addEventListener('click', ()=> openRoom(id)); return li;
  }
  function incrementBadge(li){ const badge=li.querySelector('.badge'); const n=Number(badge.textContent||'0')+1; badge.textContent=String(n); badge.style.display='inline-block'; }
  function clearBadge(li){ const b=li.querySelector('.badge'); if(b){ b.textContent='0'; b.style.display='none'; } }
  function fmtTime2(ts){ return new Date(Number(ts||Date.now())).toLocaleString(); }

  async function openRoom(id){
    currentRoomId = id;
    adminMessages.innerHTML = '';
    roomTitle.textContent = 'Carregando...';
    adminMsgInput.disabled = true; adminMsgForm.querySelector('button').disabled = true;

    const roomSnap = await get(child(ref(db), `chats/${id}`));
    const data = roomSnap.val() || {};
    roomTitle.textContent = data.userLabel || id;

    onValue(ref(db, `chats/${id}/status`), (s)=>{
      const st = s.val() || {};
      roomStatusDot.classList.toggle('online', !!st.userOnline);
      roomStatusText.textContent = st.userOnline ? 'Usuário online' : (st.userLastSeen ? `Último acesso: ${fmtTime2(st.userLastSeen)}` : 'Usuário offline');
    });

    const li = [...roomsList.children].find(x => x.dataset.id === id); if(li) clearBadge(li);
    update(ref(db, `chats/${id}/status`), { adminOnline: true, adminLastSeen: serverTimestamp() });

    const msgsRefLocal = ref(db, `chats/${id}/messages`);
    currentMsgsRef = msgsRefLocal;
    onChildAdded(msgsRefLocal, (snap)=>{
      const m = snap.val();
      const isToUser = m.destinatario === "Usuário";
      const bubble = document.createElement('div');
      bubble.className = `msg ${isToUser ? 'adm' : 'me'}`;
      bubble.innerHTML = `${escapeHtml(m.texto)}<span class="time">${fmtTime2(m.timestamp)}</span>`;
      adminMessages.appendChild(bubble);
      scrollBottom(adminMessages);
    });

    adminMsgInput.disabled = false; adminMsgForm.querySelector('button').disabled = false;
  }

  // ========= INICIALIZAÇÃO APÓS LOGIN ANÔNIMO =========
  onAuthStateChanged(auth, async (user)=>{
    if(!user){
      try { await signInAnonymously(auth); }
      catch (e) { console.error('[Auth] Falha no login anônimo', e); }
      return;
    }

    // ---- Usuário (cliente) ----
    // carrega estado salvo (se houver) e ativa handlers
    loadFromLocal();

    if(loginForm){
      loginForm.addEventListener('submit', (e)=>{
        e.preventDefault();
        const nome = nomeInput.value.trim();
        const setor = setorInput.value.trim();
        if(!nome || !setor) return;

        roomId = `${slugify(nome)}-${slugify(setor)}`;
        userLabel = `${nome} (${setor})`;
        localStorage.setItem('chatUser', JSON.stringify({ nome, setor, roomId, userLabel }));
        openChatUI(nome, setor);
        attachRoom(nome, setor);
      });
    }

    if(msgForm){
      msgForm.addEventListener('submit', (e)=>{
        e.preventDefault();
        if(!msgsRef) return;
        const text = msgInput.value.trim();
        if(!text) return;
        push(msgsRef, { autor: userLabel, texto: text, timestamp: Date.now(), destinatario: "ADM" });
        update(roomRef, { lastMessage: text, lastMessageAt: serverTimestamp(), lastMessageDest: "ADM", lastSeenUser: serverTimestamp() });
        msgInput.value = "";
        scrollBottom(messagesEl);
      });
    }

    if(sairBtn){
      sairBtn.addEventListener('click', ()=>{
        if(roomId){
          set(ref(db, `chats/${roomId}/status/userOnline`), false);
          set(ref(db, `chats/${roomId}/status/userLastSeen`), Date.now());
        }
        localStorage.removeItem('chatUser');
        window.location.reload();
      });
    }

    // ---- ADM ----
    if(roomsList){
      onChildAdded(ref(db, 'chats'), (snap)=>{
        const id = snap.key; const data = snap.val() || {};
        const li = renderRoomLi(id, data); roomsList.appendChild(li);
        onValue(ref(db, `chats/${id}`), (s)=>{
          const d = s.val() || {};
          const sub = li.querySelector('.sub');
          sub.textContent = d.lastMessage ? `${d.lastMessage} • ${new Date(d.lastMessageAt||Date.now()).toLocaleTimeString()}` : 'Sem mensagens';
          if(currentRoomId !== id && d.lastMessage && d.lastMessageDest === "ADM"){
            incrementBadge(li);
            try{ ding.currentTime = 0; ding.play(); }catch{}
          }
        });
      });

      if(filterInput){
        filterInput.addEventListener('input', ()=>{
          const q = filterInput.value.toLowerCase();
          [...roomsList.children].forEach(li=>{
            const t = (li.querySelector('.title').textContent + ' ' + li.querySelector('.sub').textContent).toLowerCase();
            li.style.display = t.includes(q) ? '' : 'none';
          });
        });
      }

      adminMsgForm.addEventListener('submit', (e)=>{
        e.preventDefault();
        const text = adminMsgInput.value.trim();
        if(!text || !currentRoomId || !currentMsgsRef) return;
        push(currentMsgsRef, { autor: "ADM", texto: text, timestamp: Date.now(), destinatario: "Usuário" });
        update(ref(db, `chats/${currentRoomId}`), {
          lastMessage: text, lastMessageAt: serverTimestamp(), lastMessageDest: "Usuário", "status/adminLastSeen": serverTimestamp()
        });
        adminMsgInput.value = ''; scrollBottom(adminMessages);
      });

      window.addEventListener('beforeunload', ()=>{
        if(currentRoomId){
          update(ref(db, `chats/${currentRoomId}/status`), { adminOnline: false, adminLastSeen: serverTimestamp() });
        }
      });
    }
  });

  // (opcional) logs de erro global
  window.addEventListener('error', e => console.error('[window.error]', e.message));
  window.addEventListener('unhandledrejection', e => console.error('[unhandledrejection]', e.reason));
</script>
</body>
</html>

