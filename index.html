<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chat Online • Usuário / ADM</title>
  <style>
    :root{
      --bg:#101418; --panel:#151a20; --card:#1b2129; --bubble-user:#2a2f36;
      --bubble-adm:#0e5f3b; --text:#e6eef7; --muted:#a7b0bb; --line:#242a32; --accent:#00e29f;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0; background:var(--bg); color:var(--text); font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial}
    a.link{color:var(--muted); text-decoration:none} a.link:hover{text-decoration:underline}
    .login-card{max-width:420px; margin:10vh auto; padding:24px; background:var(--card); border:1px solid var(--line); border-radius:12px}
    .login-card h1{margin:0 0 12px} .login-card label{display:block; margin:12px 0 6px; color:var(--muted)}
    .login-card input{width:100%; padding:12px; border-radius:8px; border:1px solid var(--line); background:#0c1014; color:var(--text)}
    .login-card button{margin-top:16px; width:100%; padding:12px; border:0; border-radius:8px; background:var(--accent); color:#002417; font-weight:700; cursor:pointer}
    .hint{color:var(--muted); font-size:14px}
    .hidden{display:none!important}
    .chat-wrap{display:flex; flex-direction:column; height:100vh; max-width:920px; margin:0 auto}
    .chat-header{display:flex; align-items:center; justify-content:space-between; padding:12px 16px; border-bottom:1px solid var(--line); background:var(--panel); position:sticky; top:0; z-index:10}
    .chat-title{font-weight:700} .chat-subtitle{color:var(--muted); font-size:13px}
    .btn-link,.link{background:none; border:0; color:var(--muted); cursor:pointer}
    .messages{flex:1; overflow-y:auto; padding:16px; background:linear-gradient(#0c1116,#0b0e12)}
    .msg{max-width:70%; padding:10px 12px; margin:6px 0; border-radius:14px; position:relative; word-wrap:break-word; white-space:pre-wrap}
    .msg .time{display:block; margin-top:6px; font-size:11px; color:var(--muted); text-align:right; opacity:.8}
    .me{background:var(--bubble-user); border-top-left-radius:4px}
    .adm{background:var(--bubble-adm); border-top-right-radius:4px}
    .center{margin:10px auto; text-align:center; color:var(--muted); font-size:12px}
    .composer{border-top:1px solid var(--line); background:var(--panel); padding:10px}
    .composer form{display:flex; gap:10px}
    .composer input{flex:1; padding:12px; border-radius:999px; border:1px solid var(--line); background:#0c1014; color:var(--text)}
    .composer button{padding:0 18px; border-radius:999px; border:0; background:var(--accent); color:#002417; font-weight:800; cursor:pointer}
    .admin-layout{display:grid; grid-template-columns:320px 1fr; height:100vh}
    .sidebar{border-right:1px solid var(--line); background:var(--panel); display:flex; flex-direction:column}
    .brand{padding:14px 16px; font-weight:800; border-bottom:1px solid var(--line)}
    .search{padding:8px 10px; border-bottom:1px solid var(--line)}
    .search input{width:100%; padding:10px; border-radius:8px; border:1px solid var(--line); background:#0c1014; color:var(--text)}
    .rooms{list-style:none; margin:0; padding:0; overflow-y:auto}
    .room{padding:12px 14px; border-bottom:1px solid var(--line); cursor:pointer; display:flex; gap:10px; align-items:center}
    .room:hover{background:#10161d}
    .room .title{font-weight:700} .room .sub{color:var(--muted); font-size:12px}
    .badge{background:var(--accent); color:#002417; font-weight:800; padding:0 8px; border-radius:999px; font-size:12px; margin-left:auto}
    .dot{display:inline-block; width:8px; height:8px; border-radius:50%; background:#666; margin-right:6px; vertical-align:middle}
    .dot.online{background:#1bd760}
    #view-user{display:block} #view-admin{display:none}
  </style>
</head>
<body>

  <!-- ============ VIEW: USUÁRIO ============ -->
  <div id="view-user">
    <div id="app">
      <section class="login-card" id="loginCard">
    <h1>Entrar no Chat</h1>
      <form id="loginForm">
        <label>Nome</label>
        <input id="nomeInput" required placeholder="Ex.: Ana" />
        <label>Setor</label>
        <input id="setorInput" required placeholder="Ex.: Financeiro" />
        <label>Assunto</label>
        <input id="assuntoInput" required placeholder="Ex.: Dúvida sobre boleto" />
        <button type="submit">Entrar</button>
      </form>
        <p class="hint">
        Seu chat abrirá em tempo real com o administrador.
        </p>
      </section>

      <section class="chat-wrap hidden" id="chatWrap">
        <header class="chat-header">
          <div>
            <div class="chat-title" id="chatTitle">—</div>
            <div class="chat-subtitle"><span id="statusDot" class="dot"></span><span id="statusText">Conectando…</span></div>
          </div>
          <button id="sairBtn" class="btn-link">sair</button>
        </header>

        <main id="messages" class="messages"></main>

        <footer class="composer">
          <form id="msgForm">
            <input id="msgInput" placeholder="Digite sua mensagem" autocomplete="off" />
            <button type="submit" title="Enviar">➤</button>
          </form>
        </footer>
      </section>
    </div>
  </div>

  <!-- ============ VIEW: ADM ============ -->
  <div id="view-admin">
    <div class="admin-layout">
      <aside class="sidebar">
        <div class="brand">Painel do ADM</div>
        <div class="search"><input id="filterInput" placeholder="Filtrar por nome/setor" /></div>
        <ul id="roomsList" class="rooms"></ul>
      </aside>

      <section class="chat-area">
        <header class="chat-header">
          <div>
            <div class="chat-title" id="roomTitle">Selecione uma conversa</div>
            <div class="chat-subtitle"><span id="roomStatusDot" class="dot"></span><span id="roomStatusText"></span></div>
          </div>
          <a class="link" href="#/user">← Voltar ao usuário</a>
        </header>

        <main id="adminMessages" class="messages"></main>

        <footer class="composer">
          <form id="adminMsgForm">
            <input id="adminMsgInput" placeholder="Escreva uma resposta…" autocomplete="off" disabled />
            <button type="submit" title="Enviar" disabled>➤</button>
          </form>
        </footer>
      </section>
    </div>

    <audio id="ding" preload="auto">
      <source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" type="audio/ogg">
    </audio>
  </div>

  <!-- ====================== SCRIPTS ====================== -->
<script type="module">
  // ===== Imports Firebase =====
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import { getDatabase, ref, onChildAdded, push, set, serverTimestamp, onDisconnect, onValue, update, get, child } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
  import { getStorage, ref as sref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js";
  import { firebaseConfig } from "./firebase-config.js";

  // ===== Firebase init & Auth anônimo =====
  const app = initializeApp(firebaseConfig);
  const db  = getDatabase(app);
  const auth = getAuth(app);
  const storage = getStorage(app);

  // ===== Helpers & DOM =====
  const $ = s => document.querySelector(s);
  const fmt = ts => new Date(Number(ts||Date.now())).toLocaleString();
  const esc = s => String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  const slug = s => s.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().trim().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');

  // user
  const loginCard=$('#loginCard'), chatWrap=$('#chatWrap');
  const loginForm=$('#loginForm'), nomeInput=$('#nomeInput'), setorInput=$('#setorInput'), assuntoInput=$('#assuntoInput');
  const chatTitle=$('#chatTitle'), messagesEl=$('#messages'), msgForm=$('#msgForm'), msgInput=$('#msgInput');
  const statusDot=$('#statusDot'), statusText=$('#statusText'), sairBtn=$('#sairBtn');

  // adm
  const roomsList=$('#roomsList'), filterInput=$('#filterInput'), adminMessages=$('#adminMessages');
  const roomTitle=$('#roomTitle'), roomStatusDot=$('#roomStatusDot'), roomStatusText=$('#roomStatusText');
  const adminMsgForm=$('#adminMsgForm'), adminMsgInput=$('#adminMsgInput'), ding=$('#ding');

  // estado
  let roomId=null, userLabel=null, roomRef=null, msgsRef=null, assunto=null;
  let currentRoomId=null, currentMsgsRef=null;

  function openChatUI(nome,setor){
    loginCard.classList.add('hidden'); chatWrap.classList.remove('hidden');
    chatTitle.textContent = `${nome} • ${setor} — ${assunto}`;
  }
  function resetUserView(){ loginCard.classList.remove('hidden'); chatWrap.classList.add('hidden'); }
  function scroll(el){ el.scrollTop = el.scrollHeight; }

  // ====== TIPING INDICATOR ======
  function setTyping(roomId, who, val){
    const p = ref(db, `chats/${roomId}/status/typing/${who}`);
    set(p, !!val); onDisconnect(p).set(false);
  }
  function listenTyping(roomId, whoIsOther, targetEl){
    onValue(ref(db, `chats/${roomId}/status/typing/${whoIsOther}`), s=>{
      const v = !!s.val();
      let tip = document.getElementById('typingHint');
      if(!tip){ tip=document.createElement('div'); tip.id='typingHint'; tip.className='center'; targetEl.appendChild(tip); }
      tip.textContent = v ? (whoIsOther==='admin' ? 'ADM está digitando…' : 'Usuário está digitando…') : '';
    });
  }

  // ====== DELIVERY / SEEN ======
  function markSeenIfToUser(messageKey){
    // chamado no lado Usuário quando recebe msg destinada a "Usuário"
    update(ref(db, `chats/${roomId}/messages/${messageKey}`), { readAt: serverTimestamp() });
  }
  function markSeenIfToAdmin(roomId, messageKey){
    update(ref(db, `chats/${roomId}/messages/${messageKey}`), { readAt: serverTimestamp() });
  }

  // ====== USER SIDE ======
  function attachRoom(nome,setor){
    roomRef = ref(db, `chats/${roomId}`);
    msgsRef = ref(db, `chats/${roomId}/messages`);

    update(roomRef, {
      userLabel,
      assunto,
      createdAt: serverTimestamp(),
      lastSeenUser: serverTimestamp(),
      status: { closed:false, userOnline:true, adminOnline:false, typing:{user:false, admin:false} }
    });

    const presenceRef = ref(db, `chats/${roomId}/status/userOnline`);
    const lastSeenRef = ref(db, `chats/${roomId}/status/userLastSeen`);
    set(presenceRef, true); onDisconnect(presenceRef).set(false); onDisconnect(lastSeenRef).set(serverTimestamp());

    // ADM online?
    onValue(ref(db, `chats/${roomId}/status/adminOnline`), snap=>{
      const online = !!snap.val();
      statusDot.classList.toggle('online', online);
      statusText.textContent = online ? 'ADM online' : 'ADM offline';
    });

    // typing do ADM
    listenTyping(roomId, 'admin', messagesEl);

    // stream de mensagens (lado usuário)
    messagesEl.innerHTML = `<div class="center">Chat aberto. Fale com o ADM.</div>`;
    onChildAdded(msgsRef, ss=>{
      const k = ss.key;
      const m = ss.val();
      const isAdmToUser = m.destinatario === 'Usuário';
      const b = document.createElement('div');
      b.className = `msg ${isAdmToUser ? 'adm':'me'}`;

      if(m.type === 'image'){
        b.innerHTML = `<a class="link" href="${esc(m.url)}" target="_blank">[imagem]</a><span class="time">${fmt(m.timestamp)} ${m.readAt?'• Lido':''}</span>`;
      }else{
        b.innerHTML = `${esc(m.texto)}<span class="time">${fmt(m.timestamp)} ${m.readAt?'• Lido':''}</span>`;
      }

      messagesEl.appendChild(b);
      scroll(messagesEl);

      // se recebi algo pra mim, marco como lido
      if(isAdmToUser){ markSeenIfToUser(k); }
    });
  }

  // load local
  function loadFromLocal(){
    try{
      const saved = JSON.parse(localStorage.getItem('chatUser')||'null');
      if(saved && saved.roomId && saved.userLabel && saved.nome && saved.setor && saved.assunto){
        ({ roomId, userLabel, assunto } = saved);
        openChatUI(saved.nome, saved.setor);
        attachRoom(saved.nome, saved.setor);
      } else { resetUserView(); }
    }catch{ resetUserView(); }
  }

  // ====== ADM SIDE ======
  function renderRoomLi(id, data){
    const li = document.createElement('li'); li.className='room'; li.dataset.id=id;
    const title = document.createElement('div'); title.className='title';
    title.textContent = (data.userLabel||id) + (data.assunto?` • ${data.assunto}`:'');
    const sub = document.createElement('div'); sub.className='sub';
    sub.textContent = data.lastMessage ? `${data.lastMessage} • ${new Date(data.lastMessageAt||Date.now()).toLocaleTimeString()}` : 'Sem mensagens';
    const badge = document.createElement('span'); badge.className='badge'; badge.textContent='0'; badge.style.display='none';
    li.append(title, sub, badge); li.addEventListener('click', ()=> openRoom(id)); return li;
  }
  function incBadge(li){ const b=li.querySelector('.badge'); b.textContent=String(Number(b.textContent||'0')+1); b.style.display='inline-block'; }
  function clrBadge(li){ const b=li.querySelector('.badge'); if(b){ b.textContent='0'; b.style.display='none'; } }

  async function openRoom(id){
    currentRoomId = id; adminMessages.innerHTML=''; roomTitle.textContent='Carregando...';
    adminMsgInput.disabled=true; adminMsgForm.querySelector('button').disabled=true;

    const roomSnap = await get(child(ref(db), `chats/${id}`));
    const data = roomSnap.val()||{};
    roomTitle.textContent = (data.userLabel||id) + (data.assunto?` • ${data.assunto}`:'');

    // status & typing do usuário
    onValue(ref(db, `chats/${id}/status`), s=>{
      const st=s.val()||{};
      roomStatusDot.classList.toggle('online', !!st.userOnline);
      roomStatusText.textContent = st.userOnline ? 'Usuário online' : (st.userLastSeen ? `Último acesso: ${fmt(st.userLastSeen)}` : 'Usuário offline');

      // "está digitando"
      let tip=document.getElementById('admTyping');
      if(!tip){ tip=document.createElement('div'); tip.id='admTyping'; tip.className='center'; adminMessages.appendChild(tip); }
      tip.textContent = st.typing && st.typing.user ? 'Usuário está digitando…' : '';
    });

    // limpar badge
    const li=[...roomsList.children].find(x=>x.dataset.id===id); if(li) clrBadge(li);

    // me marca online
    update(ref(db, `chats/${id}/status`), { adminOnline:true, adminLastSeen:serverTimestamp() });

    // stream de mensagens (lado ADM)
    const mref = ref(db, `chats/${id}/messages`); currentMsgsRef=mref;
    onChildAdded(mref, ss=>{
      const k=ss.key, m=ss.val(); const toUser = m.destinatario==='Usuário';
      const b=document.createElement('div'); b.className=`msg ${toUser?'adm':'me'}`;

      if(m.type==='image'){
        b.innerHTML = `<a class="link" href="${esc(m.url)}" target="_blank">[imagem]</a><span class="time">${fmt(m.timestamp)} ${m.readAt?'• Lido':''}</span>`;
      }else{
        b.innerHTML = `${esc(m.texto)}<span class="time">${fmt(m.timestamp)} ${m.readAt?'• Lido':''}</span>`;
      }

      adminMessages.appendChild(b); scroll(adminMessages);

      // se recebi algo para ADM, marcar como lido
      if(m.destinatario==='ADM'){ markSeenIfToAdmin(id, k); }
    });

    // habilita composer (desabilita se fechado)
    const closed = (data.status && data.status.closed) || false;
    adminMsgInput.disabled = closed; adminMsgForm.querySelector('button').disabled = closed;
  }

  // ====== Inicialização após Auth ======
  onAuthStateChanged(auth, async (user)=>{
    if(!user){ try{ await signInAnonymously(auth); }catch(e){ console.error('auth anon failed', e); } return; }

    // USER FLOW
    (function initUser(){
      loadFromLocal();

      if(loginForm){
        loginForm.addEventListener('submit', e=>{
          e.preventDefault();
          const nome=nomeInput.value.trim(), setor=setorInput.value.trim();
          assunto = assuntoInput.value.trim();
          if(!nome || !setor || !assunto) return;

          roomId = `${slug(nome)}-${slug(setor)}-${Date.now()}`;
          userLabel = `${nome} (${setor})`;
          localStorage.setItem('chatUser', JSON.stringify({ nome,setor,assunto, roomId,userLabel }));
          openChatUI(nome,setor);
          attachRoom(nome,setor);
        });
      }

      if(msgForm){
        msgForm.addEventListener('submit', async e=>{
          e.preventDefault(); if(!msgsRef) return;
          const text = msgInput.value.trim(); if(!text) return;
          const res = await push(msgsRef, { autor:userLabel, texto:text, timestamp:Date.now(), destinatario:"ADM" });
          // delivered
          await update(ref(db, `chats/${roomId}/messages/${res.key}`), { deliveredAt: serverTimestamp() });
          await update(roomRef, { lastMessage:text, lastMessageAt:serverTimestamp(), lastMessageDest:"ADM", lastSeenUser:serverTimestamp() });
          msgInput.value=""; scroll(messagesEl);
        });

        // typing
        msgInput.addEventListener('input', ()=> setTyping(roomId, 'user', msgInput.value.trim().length>0));
        msgInput.addEventListener('blur',  ()=> setTyping(roomId, 'user', false));
      }

      if(sairBtn){
        sairBtn.addEventListener('click', ()=>{
          if(roomId){
            set(ref(db, `chats/${roomId}/status/userOnline`), false);
            set(ref(db, `chats/${roomId}/status/userLastSeen`), Date.now());
          }
          localStorage.removeItem('chatUser'); window.location.reload();
        });
      }
    })();

    // ADM FLOW
    (function initAdmin(){
      if(!roomsList) return;

      onChildAdded(ref(db, 'chats'), (snap)=>{
        const id=snap.key, data=snap.val()||{};
        const li = renderRoomLi(id,data); roomsList.appendChild(li);

        // atualizações
        onValue(ref(db, `chats/${id}`), s=>{
          const d=s.val()||{};
          li.querySelector('.sub').textContent = d.lastMessage ? `${d.lastMessage} • ${new Date(d.lastMessageAt||Date.now()).toLocaleTimeString()}` : 'Sem mensagens';
          if(currentRoomId!==id && d.lastMessage && d.lastMessageDest==="ADM"){ incBadge(li); try{ ding.currentTime=0; ding.play(); }catch{} }
        });
      });

      if(filterInput){
        filterInput.addEventListener('input', ()=>{
          const q=filterInput.value.toLowerCase();
          [...roomsList.children].forEach(li=>{
            const t=(li.querySelector('.title').textContent+' '+li.querySelector('.sub').textContent).toLowerCase();
            li.style.display = t.includes(q)?'':'none';
          });
        });
      }

      // enviar do ADM
      adminMsgForm.addEventListener('submit', async e=>{
        e.preventDefault();
        const text=adminMsgInput.value.trim();
        if(!text || !currentRoomId || !currentMsgsRef) return;
        const res = await push(currentMsgsRef, { autor:"ADM", texto:text, timestamp:Date.now(), destinatario:"Usuário" });
        await update(ref(db, `chats/${currentRoomId}/messages/${res.key}`), { deliveredAt: serverTimestamp() });
        await update(ref(db, `chats/${currentRoomId}`), { lastMessage:text, lastMessageAt:serverTimestamp(), lastMessageDest:"Usuário", "status/adminLastSeen":serverTimestamp() });
        adminMsgInput.value=''; scroll(adminMessages);
      });

      // typing ADM
      adminMsgInput.addEventListener('input', ()=>{
        if(!currentRoomId) return; setTyping(currentRoomId, 'admin', adminMsgInput.value.trim().length>0);
      });
      adminMsgInput.addEventListener('blur', ()=>{ if(currentRoomId) setTyping(currentRoomId, 'admin', false); });

      // finalizar atendimento (atalho: Ctrl+Enter no ADM zera/fecha sala)
      window.addEventListener('keydown', async (e)=>{
        if(e.ctrlKey && e.key==='Enter' && currentRoomId){
          await update(ref(db, `chats/${currentRoomId}/status`), { closed:true });
          adminMsgInput.disabled = true; adminMsgForm.querySelector('button').disabled = true;
          // envia aviso
          push(currentMsgsRef, { autor:"Sistema", texto:"Atendimento finalizado pelo ADM.", timestamp:Date.now(), destinatario:"Usuário" });
        }
      });

      // marcar ADM offline ao sair
      window.addEventListener('beforeunload', ()=>{
        if(currentRoomId){
          update(ref(db, `chats/${currentRoomId}/status`), { adminOnline:false, adminLastSeen:serverTimestamp() });
        }
      });
    })();
  });

  // ===== AVALIAÇÃO (User) – aparece quando sala fechada =====
  onValue(ref(db, `chats`), s=>{
    // mostra formulário de avaliação para a sala local do usuário, se fechada e sem rating
    const saved = JSON.parse(localStorage.getItem('chatUser')||'null');
    if(!saved) return;
    const r = s.child(saved.roomId); if(!r.exists()) return;
    const val = r.val();
    if(val?.status?.closed && !val?.rating && document.getElementById('rateForm')==null){
      const box=document.createElement('div'); box.id='rateForm'; box.className='login-card'; box.style.margin='16px';
      box.innerHTML=`
        <h3>Como foi seu atendimento?</h3>
        <form id="ratingForm">
          <label>Nota (1 a 5)</label>
          <input id="ratingInput" type="number" min="1" max="5" required />
          <label>Comentário (opcional)</label>
          <input id="ratingComment" placeholder="Deixe seu feedback" />
          <button type="submit">Enviar avaliação</button>
        </form>`;
      (chatWrap||document.body).appendChild(box);
      $('#ratingForm').addEventListener('submit', async e=>{
        e.preventDefault();
        const nota = Number($('#ratingInput').value);
        const comt = $('#ratingComment').value.trim();
        await update(ref(db, `chats/${saved.roomId}`), { rating:{ score:nota, comment:comt, at:serverTimestamp() } });
        box.remove();
      });
    }
  });

  // ===== Upload de imagem (User) – opcional, 5MB máx (auto-apagar precisa Function) =====
  // Exemplo rápido: você pode adicionar um input file no HTML e chamar esta função:
  async function sendImage(file){
    if(!msgsRef || !file) return;
    if(file.size > 5*1024*1024){ alert('Máx 5MB'); return; }
    const p = sref(storage, `uploads/${roomId}/${Date.now()}-${file.name}`);
    await uploadBytes(p, file);
    const url = await getDownloadURL(p);
    const res = await push(msgsRef, { type:'image', url, timestamp:Date.now(), destinatario:'ADM', autor:userLabel });
    await update(ref(db, `chats/${roomId}/messages/${res.key}`), { deliveredAt: serverTimestamp() });
    // Para apagar em 5 min: usar Cloud Function (abaixo)
  }

  // Logs globais
  window.addEventListener('error', e=>console.error('[error]', e.message));
  window.addEventListener('unhandledrejection', e=>console.error('[promise]', e.reason));
</script>
</body>
</html>



